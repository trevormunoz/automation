upstream iip {
    server unix:/var/run/iipserver.sock fail_timeout=0;
}

server {

    listen 80;
    server_name {{ server_name }};
    root /var/www/iipimage;
    rewrite_log on;
    rewrite ^/iiif/(.*)$ /fcgi-bin/iipserver.fcgi?IIIF=$1 last;

    location /fcgi-bin/iipserver.fcgi {
      fastcgi_pass    iip;
      fastcgi_param   PATH_INFO $fastcgi_script_name;
      fastcgi_param   REQUEST_METHOD $request_method;
      fastcgi_param   QUERY_STRING $query_string;
      fastcgi_param   CONTENT_TYPE $content_type;
      fastcgi_param   CONTENT_LENGTH $content_length;
      add_header 'Access-Control-Allow-Origin' '*';
    }

    include conf/global/restrictions.conf;
}
